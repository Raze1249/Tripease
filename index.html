<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tripease - Real-Time Search & Booking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Styles to enhance Tailwind */
        body { font-family: 'Inter', sans-serif; background: #f4f9ff; }
        .hero {
            background: #006d77;
            background-image: url("https://placehold.co/1000x200/006d77/ffffff?text=Tripease");
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        
        /* Autocomplete List Styling */
        .autocomplete-list {
            position: absolute;
            z-index: 10;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            border-top: none;
            width: 100%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background: white;
            border-radius: 0 0 8px 8px;
        }
        .autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .autocomplete-item:hover, .autocomplete-item.active {
            background-color: #e0f2f1; /* Light cyan color */
            color: #006d77;
            font-weight: 600;
        }
        .input-wrapper {
            position: relative;
        }
        
        /* Trip Item Styling */
        .trip-item {
            border-left: 5px solid #118ab2;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            #form-section {
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }
            #results-section {
                padding-left: 0;
                padding-top: 20px;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <header class="bg-gray-800 text-white p-4 shadow-lg">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-bold text-yellow-400">üåç Tripease</h1>
            <nav>
                <a href="#" class="text-gray-300 hover:text-yellow-400 px-3 py-2 rounded-md transition duration-150">Home</a>
                <a href="#" class="text-gray-300 hover:text-yellow-400 px-3 py-2 rounded-md transition duration-150">Bookings</a>
            </nav>
        </div>
    </header>

    <div class="hero text-center py-20">
        <h1 class="text-5xl font-extrabold mb-2">‚ÄúTurning every journey into a smart experience‚Äù</h1>
        <p class="text-xl font-medium">Search real data (via Aviationstack) and book to MongoDB.</p>
    </div>

    <div class="max-w-6xl mx-auto mt-8 p-4 md:p-8 bg-white rounded-xl shadow-2xl flex flex-wrap gap-6">
        
        <div id="notification" class="hidden w-full p-3 rounded-lg font-semibold text-center transition duration-300"></div>
        
        <div id="form-section" class="flex-1 min-w-80 md:pr-6 md:border-r border-gray-200">
            <h2 class="text-2xl font-bold text-[#006d77] text-center mb-6 pb-2 border-b-2 border-gray-100">‚úàÔ∏è Search & Book</h2>
            <form id="search-form" class="grid gap-4">
                <input type="text" id="full-name" placeholder="Your Full Name (for booking)" required 
                       class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#118ab2] focus:border-[#118ab2]">
                
                <!-- From City/Airport with Autocomplete -->
                <div class="input-wrapper">
                    <input type="text" id="from-city" placeholder="From (City or IATA Code)" required 
                           class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#118ab2] focus:border-[#118ab2]">
                    <div id="from-autocomplete-list" class="autocomplete-list"></div>
                </div>

                <!-- To City/Airport with Autocomplete -->
                <div class="input-wrapper">
                    <input type="text" id="to-city" placeholder="To (City or IATA Code)" required 
                           class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#118ab2] focus:border-[#118ab2]">
                    <div id="to-autocomplete-list" class="autocomplete-list"></div>
                </div>
                
                <input type="date" id="departure-date" required 
                       class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#118ab2] focus:border-[#118ab2]">
                
                <select id="seats" required
                        class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#118ab2] focus:border-[#118ab2]">
                    <option value="1">1 Passenger</option>
                    <option value="2">2 Passengers</option>
                    <option value="3">3 Passengers</option>
                    <option value="4">4 Passengers</option>
                </select>
                <button type="submit" id="search-button"
                        class="p-3 bg-[#118ab2] text-white font-bold rounded-lg hover:bg-[#073b4c] transition duration-200">
                    Search Flights
                </button>
            </form>
        </div>

        <div id="results-section" class="flex-1 min-w-80 md:pl-6">
            <h2 class="text-2xl font-bold text-[#006d77] text-center mb-6 pb-2 border-b-2 border-gray-100">Live Search Results (Mock Data)</h2>
            <div id="flight-results-container" class="mt-4">
                <p class="text-gray-500 text-center py-10">
                    Enter your details and click 'Search Flights' to see mock real-time options!
                </p>
            </div>
        </div>

        <div id="trips-list" class="w-full mt-8 pt-6 border-t-2 border-[#006d77]">
            <h3 class="text-xl font-bold text-[#118ab2] text-center mb-6">Recent Booked Trips (Saved to MongoDB)</h3>
            <div id="trip-items-container" class="grid md:grid-cols-2 gap-4">
                <p class="text-yellow-700 text-center col-span-full">Loading trips...</p>
            </div>
        </div>
    </div>

    <footer class="text-center py-6 mt-10 bg-gray-800 text-gray-400">
        <p>¬© 2025 Tripease | Full-Stack Connectivity Project</p>
    </footer>

    <script>
        // --- Configuration ---
        // IMPORTANT: Ensure this port matches the one in your server.cjs
        const API_BASE_URL = 'http://localhost:3000/api'; 
        // ---------------------

        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('search-form');
            const searchButton = document.getElementById('search-button');
            const notification = document.getElementById('notification');
            const tripItemsContainer = document.getElementById('trip-items-container');
            const flightResultsContainer = document.getElementById('flight-results-container');
            
            const fromCityInput = document.getElementById('from-city');
            const toCityInput = document.getElementById('to-city');
            const fromAutocompleteList = document.getElementById('from-autocomplete-list');
            const toAutocompleteList = document.getElementById('to-autocomplete-list');

            let allAirports = []; // To store data fetched from the backend's cache

            // --- Utility Functions ---

            function showNotification(message, type) {
                notification.textContent = message;
                notification.className = `w-full p-3 rounded-lg font-semibold text-center transition duration-300 block 
                    ${type === 'loading' ? 'bg-yellow-100 text-yellow-700' : 
                      type === 'success' ? 'bg-green-100 text-green-700' : 
                      'bg-red-100 text-red-700'}`;
            }

            function setButtonLoading(isLoading) {
                searchButton.disabled = isLoading;
                searchButton.textContent = isLoading ? 'Searching...' : 'Search Flights';
                
                if (isLoading) {
                    flightResultsContainer.innerHTML = '<p class="text-yellow-700 text-center py-10">Searching flights...</p>';
                }
            }

            // --- Autocomplete Logic (Using Cached Aviationstack Data) ---
            
            async function fetchAirportData() {
                try {
                    const response = await fetch(`${API_BASE_URL}/airports`);
                    if (!response.ok) throw new Error('Failed to fetch airport data from backend.');
                    allAirports = await response.json();
                    console.log(`Frontend loaded ${allAirports.length} airports for autocomplete.`);
                } catch (error) {
                    console.error('Error fetching airports for autocomplete:', error);
                    // Continue without autocomplete if fetch fails
                }
            }
            
            function filterAirports(query, airportList) {
                if (!query) return [];
                const lowerQuery = query.toLowerCase();
                return airportList.filter(airport =>
                    airport.iata.toLowerCase().startsWith(lowerQuery) || 
                    airport.city.toLowerCase().includes(lowerQuery) || 
                    airport.name.toLowerCase().includes(lowerQuery)
                ).slice(0, 10); // Limit results to 10
            }

            function renderAutocomplete(inputElement, listElement, results) {
                listElement.innerHTML = '';
                if (results.length === 0) {
                    listElement.style.display = 'none';
                    return;
                }

                results.forEach(airport => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    item.innerHTML = `<strong>${airport.iata}</strong> - ${airport.city}, ${airport.name}`;
                    
                    item.addEventListener('click', () => {
                        inputElement.value = airport.iata; // Set IATA code as the value
                        listElement.style.display = 'none';
                    });
                    listElement.appendChild(item);
                });
                listElement.style.display = 'block';
            }

            function setupAutocomplete(inputElement, listElement) {
                inputElement.addEventListener('input', () => {
                    const query = inputElement.value.trim();
                    const results = filterAirports(query, allAirports);
                    renderAutocomplete(inputElement, listElement, results);
                });

                // Hide list when clicking outside
                document.addEventListener('click', (e) => {
                    if (e.target !== inputElement && e.target.closest('.input-wrapper') !== inputElement.parentElement) {
                        listElement.style.display = 'none';
                    }
                });
            }


            // --- Booking and Search Logic ---

            async function fetchTrips() {
                tripItemsContainer.innerHTML = '<p class="text-yellow-700 text-center col-span-full">Loading trips...</p>';
                try {
                    const response = await fetch(`${API_BASE_URL}/trips`);
                    if (!response.ok) throw new Error(`Could not fetch trips. Status: ${response.status}`);
                    const trips = await response.json();
                    
                    if (trips.length === 0) {
                        tripItemsContainer.innerHTML = '<p class="text-gray-500 text-center col-span-full">No trips booked yet.</p>';
                        return;
                    }

                    const listHtml = trips.map(trip => `
                        <div class="trip-item bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-100">
                            <p class="text-lg font-semibold text-[#006d77]">${trip.source} $\to$ ${trip.destination}</p>
                            <p class="text-sm">
                                <span class="font-medium">Booker:</span> ${trip.name} 
                                | <span class="font-medium">Date:</span> ${trip.startDate ? new Date(trip.startDate).toLocaleDateString() : 'N/A'}
                                | <span class="font-medium">Seats:</span> ${trip.seats}
                            </p>
                        </div>
                    `).join('');

                    tripItemsContainer.innerHTML = listHtml;
                } catch (error) {
                    console.error('Error fetching trips:', error);
                    tripItemsContainer.innerHTML = `<p class="bg-red-100 text-red-700 p-3 rounded-lg col-span-full">Failed to load trips: ${error.message}</p>`;
                }
            }

            form.addEventListener('submit', async (e) => {
                e.preventDefault(); 
                setButtonLoading(true);
                showNotification('Searching flights, please wait...', 'loading');

                const searchData = {
                    source: fromCityInput.value.trim().toUpperCase(), // Ensure IATA is uppercase
                    destination: toCityInput.value.trim().toUpperCase(),
                    departureDate: document.getElementById('departure-date').value,
                };
                
                const fullName = document.getElementById('full-name').value.trim();

                try {
                    const response = await fetch(`${API_BASE_URL}/search-flights`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(searchData),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API Search Failed: ${errorData.message}`);
                    }

                    const flights = await response.json();
                    renderFlights(flights, fullName);
                    showNotification(`‚úÖ Found ${flights.length} flight options from ${searchData.source}!`, 'success');

                } catch (error) {
                    console.error('Error searching flights:', error);
                    showNotification(`‚ùå Error during search: ${error.message}`, 'error');
                    flightResultsContainer.innerHTML = `<p class="bg-red-100 text-red-700 p-3 rounded-lg text-center">Search failed: ${error.message}</p>`;
                } finally {
                    setButtonLoading(false);
                }
            });

            function renderFlights(flights, fullName) {
                if (flights.length === 0) {
                    flightResultsContainer.innerHTML = '<p class="text-gray-500 text-center py-10">No flights found for this route.</p>';
                    return;
                }

                const resultsHtml = flights.map(flight => `
                    <div class="flight-item bg-white p-4 rounded-xl mb-4 border border-gray-200 shadow hover:shadow-lg transition duration-200 flex flex-col md:flex-row justify-between items-start md:items-center">
                        <div class="flight-details flex-grow">
                            <strong class="text-xl text-[#006d77]">${flight.carrier}</strong>
                            <p class="text-sm text-gray-600">${flight.source} $\to$ ${flight.destination}</p>
                            <p class="text-xs text-gray-400">Departs: ${flight.departure} | Duration: ${flight.duration}</p>
                        </div>
                        <div class="flight-actions flex items-center mt-3 md:mt-0">
                            <span class="text-2xl font-extrabold text-[#ff6b6b] mr-4">$${flight.price}</span>
                            <button 
                                class="book-flight-btn p-3 bg-[#ff6b6b] text-white font-semibold rounded-lg hover:bg-red-500 transition duration-200" 
                                data-flight-source="${flight.source}"
                                data-flight-destination="${flight.destination}"
                                data-flight-date="${flight.date}"
                                data-full-name="${fullName}"
                                data-flight-price="${flight.price}"
                            >Book Now</button>
                        </div>
                    </div>
                `).join('');

                flightResultsContainer.innerHTML = resultsHtml;
            }

            flightResultsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('book-flight-btn')) {
                    const button = e.target;
                    const fullName = button.getAttribute('data-full-name');
                    const seats = parseInt(document.getElementById('seats').value, 10);

                    if (!fullName || fullName.length < 2) {
                        showNotification('‚ùå Please enter your full name in the form before booking!', 'error');
                        return;
                    }

                    const tripData = {
                        name: fullName,
                        source: button.getAttribute('data-flight-source'),
                        destination: button.getAttribute('data-flight-destination'),
                        startDate: button.getAttribute('data-flight-date'), 
                        seats: seats,
                    };

                    submitTripToDatabase(tripData);
                }
            });

            async function submitTripToDatabase(tripData) {
                showNotification(`Processing final booking for ${tripData.destination}...`, 'loading');
                
                try {
                    const response = await fetch(`${API_BASE_URL}/trips`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(tripData),
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to save booking to database.');
                    }

                    const result = await response.json();
                    showNotification(`‚úÖ Booking Confirmed! Trip to ${result.destination} saved to MongoDB.`, 'success');
                    fetchTrips();
                } catch (error) {
                    showNotification(`‚ùå Final Booking Failed: ${error.message}`, 'error');
                    console.error('Final database submission error:', error);
                }
            }

            // --- Initial Setup ---
            fetchTrips();
            fetchAirportData();
            setupAutocomplete(fromCityInput, fromAutocompleteList);
            setupAutocomplete(toCityInput, toAutocompleteList);

        });
    </script>
</body>
</html>
