<script>
  const API_DEST = '/api/destinations';
  const API_UNSPLASH = '/api/unsplash-image';

  const grid = document.getElementById('dest-grid');
  const msg = document.getElementById('message');
  const keywordEl = document.getElementById('dest-keyword');
  const subtypeEl = document.getElementById('dest-subtype');
  const limitEl = document.getElementById('dest-limit');
  const searchBtn = document.getElementById('dest-search');
  const randomBtn = document.getElementById('dest-random');

  const GENERIC_FALLBACK =
    'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1200&q=80';

  function showMessage(txt, isError = false) {
    msg.textContent = txt || '';
    msg.style.color = isError ? '#ffdddd' : '#dfffe6';
  }

  function clearMessage(){ showMessage(''); }

  function escapeHtml(str){
    if(!str) return '';
    return String(str)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#39;');
  }

  // Check if existing image URL looks usable
  function hasUsableImage(item) {
    const url = item.imageUrl || item.image;
    if (!url) return false;
    if (typeof url !== 'string') return false;
    if (!url.startsWith('http')) return false;
    if (url.includes('placeholder') || url.includes('default')) return false;
    return true;
  }

  // Ask backend Unsplash proxy for an image for this destination
  async function fillUnsplashImage(item) {
    if (hasUsableImage(item)) return item;

    const parts = [];
    if (item.name) parts.push(item.name);
    if (item.region) parts.push(item.region);
    if (item.address?.cityName) parts.push(item.address.cityName);
    if (item.address?.countryName) parts.push(item.address.countryName);
    parts.push('travel');

    const q = encodeURIComponent(parts.filter(Boolean).join(' ')) || 'travel destination';

    try {
      const res = await fetch(`${API_UNSPLASH}?q=${q}`);
      const json = await res.json().catch(() => ({}));
      if (json && json.url) {
        item.imageUrl = json.url;
      } else {
        item.imageUrl = GENERIC_FALLBACK;
      }
    } catch (err) {
      console.error('fillUnsplashImage error', err);
      item.imageUrl = GENERIC_FALLBACK;
    }
    return item;
  }

  function cardHtml(item){
    const img = item.imageUrl || item.image || GENERIC_FALLBACK;
    const name = item.name || item.title || 'Unknown';
    const region = item.region || item.address?.countryName || '';
    const desc = item.description || (item.raw && item.raw.detailedName) || '';
    return `
      <article class="card" role="article" aria-label="${escapeHtml(name)}">
        <img src="${img}" alt="${escapeHtml(name)}"
             onerror="this.onerror=null;this.src='${GENERIC_FALLBACK}'"/>
        <div class="body">
          <h3>${escapeHtml(name)}</h3>
          <div class="meta">${escapeHtml(region)}</div>
          <p>${escapeHtml(desc)}</p>
        </div>
      </article>
    `;
  }

  async function fetchDestinations({keyword='', subType='CITY', limit=8} = {}){
    try{
      showMessage('Searching...');
      grid.innerHTML = '';
      const q = new URLSearchParams();
      if(keyword) q.set('keyword', keyword);
      if(subType && subType !== 'ALL') q.set('subType', subType);
      q.set('limit', String(limit || 8));
      const res = await fetch(API_DEST + '?' + q.toString());
      if(!res.ok){
        await res.json().catch(()=>null); // consume body
        showMessage('No destinations (external API unavailable).', true);
        return [];
      }
      const json = await res.json();
      return Array.isArray(json.data) ? json.data : [];
    }catch(err){
      console.error('fetchDestinations error', err);
      showMessage('Failed to fetch destinations. Try again later.', true);
      return [];
    }
  }

  async function renderDestinations(params){
    try{
      clearMessage();
      const list = await fetchDestinations(params);
      if(!list || !list.length){
        grid.innerHTML = '<div style="color:#fff;padding:28px">No destinations found.</div>';
        return;
      }

      // ðŸ”¥ Ensure every item has a decent image (with overrides for key locations)
      const enhanced = await Promise.all(list.map(fillUnsplashImage));

      grid.innerHTML = enhanced.map(cardHtml).join('');
    }catch(err){
      console.error(err);
      grid.innerHTML = '<div style="color:#fff;padding:28px">Error rendering destinations.</div>';
    }
  }

  // Events
  searchBtn.addEventListener('click', ()=>{
    const kw = keywordEl.value.trim();
    const sub = subtypeEl.value;
    const lim = Number(limitEl.value) || 8;
    renderDestinations({keyword: kw, subType: sub, limit: lim});
  });

  keywordEl.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter') searchBtn.click();
  });

  randomBtn.addEventListener('click', async ()=>{
    const samples = [
      'goa beach escape',
      'kolkata cultural walk',
      'rajasthan desert camp',
      'himachal trek',
      'andaman island cruise',
      'maldives',
      'bali',
      'paris',
      'mountain',
      'island'
    ];
    const pick = samples[Math.floor(Math.random()*samples.length)];
    keywordEl.value = pick;
    subtypeEl.value = 'CITY';
    renderDestinations({keyword: pick, subType: 'CITY', limit: 12});
  });

  // Load initial destinations (popular-ish)
  (function init(){
    renderDestinations({keyword:'beach', subType:'CITY', limit:8});
  })();
</script>
